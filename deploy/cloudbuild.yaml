timeout: "1800s"
options:
  logging: CLOUD_LOGGING_ONLY

availableSecrets:
  secretManager:
    - versionName: projects/$PROJECT_ID/secrets/TELEGRAM_BOT_TOKEN/versions/latest
      env: TELEGRAM_BOT_TOKEN
    - versionName: projects/$PROJECT_ID/secrets/TELEGRAM_CHAT_ID/versions/latest
      env: TELEGRAM_CHAT_ID

substitutions:
  _REGION: europe-west1
  _SERVICE: x-bot-mei
  _REPO: x-bot-mei
  # Ajusta el bucket existente con tu proyecto
  _BUCKET_DB: xbot-473616-x-bot-mei-db
  _FALLBACK_PROVIDER_ORDER: gemini,openrouter

steps:
  # Commit metadata for notifications (subject, author, branch)
  - name: gcr.io/cloud-builders/git
    id: commit-meta
    entrypoint: bash
    args:
      - -ceu
      - |
        git log -1 --pretty=%s > .cb_commit_subject || echo "" > .cb_commit_subject
        git log -1 --pretty=%an > .cb_commit_author || echo "" > .cb_commit_author
        (git rev-parse --abbrev-ref HEAD > .cb_branch 2>/dev/null || echo "${BRANCH_NAME:-main}" > .cb_branch)

  # Notify start to Telegram (lean + clean)
  - name: gcr.io/google.com/cloudsdktool/cloud-sdk:slim
    id: notify-start
    entrypoint: bash
    secretEnv: ["TELEGRAM_BOT_TOKEN", "TELEGRAM_CHAT_ID"]
    args:
      - -ceu
      - |
        set -euo pipefail
        if [[ -z "${TELEGRAM_BOT_TOKEN:-}" || -z "${TELEGRAM_CHAT_ID:-}" ]]; then
          echo "[notify-start] Skipping Telegram notification (missing secrets)"
          exit 0
        fi
        SHORT="${SHORT_SHA:-${COMMIT_SHA:-${REVISION_ID:-unknown}}}"
        SUBJECT="$(cat .cb_commit_subject 2>/dev/null || true)"; SUBJECT=${SUBJECT:-""}
        AUTHOR="$(cat .cb_commit_author 2>/dev/null || true)"; AUTHOR=${AUTHOR:-""}
        BRANCH="$(cat .cb_branch 2>/dev/null || true)"; BRANCH=${BRANCH:-"main"}
        TEXT="ðŸš€ Deploying ${_SERVICE} â†’ ${_REGION}\nBranch: ${BRANCH}\nCommit: ${SHORT}\n${SUBJECT:+Subject: ${SUBJECT}\n}${AUTHOR:+Author: ${AUTHOR}}"
        curl -fsS -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
          -d chat_id="${TELEGRAM_CHAT_ID}" \
          --data-urlencode text="${TEXT}"

  # Build image
  - name: gcr.io/cloud-builders/docker
    args:
      ["build",
       "-t",
       "${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO}/${_SERVICE}:$SHORT_SHA",
       "."]

  # Push image
  - name: gcr.io/cloud-builders/docker
    args:
      ["push",
       "${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO}/${_SERVICE}:$SHORT_SHA"]

  # Deploy to Cloud Run (idempotent). Requiere que los secretos existan.
  - name: gcr.io/google.com/cloudsdktool/cloud-sdk:slim
    entrypoint: bash
    secretEnv: ["TELEGRAM_BOT_TOKEN", "TELEGRAM_CHAT_ID"]
    args:
      - -ceu
      - |
        set -euo pipefail
        gcloud config set project "$PROJECT_ID"
        IMG="${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO}/${_SERVICE}:$SHORT_SHA"

        # Secret refs: no leen valores en build, solo referencian nombres/versions
        SECRET_LIST="TELEGRAM_BOT_TOKEN=TELEGRAM_BOT_TOKEN:latest,GOOGLE_API_KEY=GOOGLE_API_KEY:latest,ADMIN_API_TOKEN=ADMIN_API_TOKEN:latest"
        if gcloud secrets describe OPENROUTER_API_KEY >/dev/null 2>&1; then
          SECRET_LIST="$$SECRET_LIST,OPENROUTER_API_KEY=OPENROUTER_API_KEY:latest"
        fi

        # Escapar coma usando item-delimiter ^:^
        ENV_VARS="^:^FALLBACK_PROVIDER_ORDER=${_FALLBACK_PROVIDER_ORDER}:CHROMA_DB_PATH=/mnt/db:GEMINI_MODEL=gemini-2.5-pro:SHOW_TOPIC_ID=0"

        gcloud run deploy "${_SERVICE}" \
          --image "$$IMG" \
          --region "${_REGION}" --allow-unauthenticated --port 8080 \
          --max-instances 1 --min-instances 0 \
          --set-env-vars "$$ENV_VARS" \
          --set-secrets "$$SECRET_LIST" \
          --add-volume=name=dbvol,type=cloud-storage,bucket="${_BUCKET_DB}" \
          --add-volume-mount=volume=dbvol,mount-path=/mnt/db

        # Notify success to Telegram (with service URL)
        if [[ -n "${TELEGRAM_BOT_TOKEN:-}" && -n "${TELEGRAM_CHAT_ID:-}" ]]; then
          RUN_URL=$(gcloud run services describe "${_SERVICE}" --region "${_REGION}" --format='value(status.url)')
          SHORT="${SHORT_SHA:-${COMMIT_SHA:-${REVISION_ID:-unknown}}}"
          SUBJECT="$(cat .cb_commit_subject 2>/dev/null || true)"; SUBJECT=${SUBJECT:-""}
          TEXT="âœ… Deployed ${_SERVICE} (${SHORT})\nURL: ${RUN_URL}"
          if [[ -n "$SUBJECT" ]]; then TEXT+="\n${SUBJECT}"; fi
          curl -fsS -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            --data-urlencode text="${TEXT}" || true
        else
          echo "[notify-success] Skipping Telegram notification (missing secrets)"
        fi

images:
  - "${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO}/${_SERVICE}:$SHORT_SHA"
